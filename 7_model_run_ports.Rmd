---
title: "Model runs using distance to ports  as cost"
author: "Rachel Rhodes"
date: "12/3/2020"
output: html_document
---

## Now lets to do our next set of runs using distance to ports  as a cost

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(prioritizr)
library(here)
library(tidyverse)
```

## Again, we must assign planning unit, cost, and conservation features
```{r}
## Make sure you have already run script 5 - this will load the PU and Conservation Features in your local environment

## Now we need to load a new cost layer
port_raster <- raster(here("rasters", "port_dist_rast.tif"))

## Plot and create data frame to check what it looks like
plot(port_raster)
port_df <- as.data.frame(port_raster)

#scale all values 0-1 by dividing by max value using log-transformed +1 ports values (+1 so that zero values are transformed to zero not NA)
ports<- log(port_raster+1)/ cellStats(log(port_raster+1), max)

## Create anothe data frame to make sure it looks good
ports_df_scaled <- as.data.frame(ports)
plot(ports)

## Assign the new ports raster as costs and call it "costs_ports"
cost_ports <- ports
```

## Now it's time to start building the problem or simulations for these runs using similar parameters from script 5 & 6

# SCENARIO 1: Baseline - 20% target, Boundary Penalty = 0 
```{r}
### OBJECTIVE: Minimize fishing pressure while meeting 20% representation targets, locking in MPAs, locking out oil rigs, and a boundary penalty of 0

## Define the problem with the cost, conservation features, targets, locked in and locked out constraints using the minimum set objective

prob_ports <- problem(cost_ports, features = features_stack) %>%
  add_min_set_objective() %>%
  add_relative_targets(0.2) %>%
  add_locked_in_constraints(mpa_raster) %>% 
  add_locked_out_constraints(oil_raster) %>%
  add_gurobi_solver(gap = 0.1, time_limit = 1200)

# print the problem to verify it looks right
print(prob_ports)

#solve problem
sprob_ports <- solve(prob_ports)

#plot to see results
plot(sprob_ports,  main = c("Baseline: Ports - 20% Targets"))

```

# SCENARIO 2: Boundary Penalty = 0.5
```{r}
### Now lets try setting a boundary length of 0.5
### OBJECTIVE: Minimize distance to ports cost  while meeting 20% representation targets, locking in MPAs, locking out oil rigs, and a boundary penalty of 0.5

prob_ports_blm <- problem(cost_area, features = features_stack) %>%
  add_min_set_objective() %>%
  add_relative_targets(0.2) %>%
  add_locked_in_constraints(mpa_raster) %>%
  add_locked_out_constraints(oil_raster) %>%
  add_boundary_penalties(penalty=0.5) %>%
  add_gurobi_solver(gap = 0.1, time_limit = 1200)

## Print the problem to verify it is as expected   
print(prob_ports_blm )

## Solve problem
sprob_ports_blm <- solve(prob_ports_blm )

## Plot the solution to see what it looks like
plot(sprob_ports_blm,  main = c("Ports: BLM = 0.5"))
```

# SCENARIO 3: No locked in or locked out constraints
```{r}
## SENSITIVTY ANALSYSIS TEST: Now lets run a sensitivity analysis with nothing locked in or out
### OBJECTIVE: Minimize distance to ports  while meeting 20% representation targets, without locking in MPAs, locking out oil rigs, and a boundary penalty of 0

prob_ports_no_mpas <- problem(cost_area, features = features_stack) %>%
  add_min_set_objective() %>%
  add_relative_targets(0.2) %>%
  add_gurobi_solver(gap = 0.1, time_limit = 1200)

print(prob_ports_no_mpas)

#solve problem
sprob_ports_no_mpas <- solve(prob_ports_no_mpas)

plot(sprob_ports_no_mpas,  main = c("Fishing Pressure - no MPAs"))

```

# SCENARIO 4: 10% Targets
```{r}
## SENSITIVTY ANALSYSIS TEST: Now lets run a sensitivity analysis with 10% targets

### OBJECTIVE: Minimize area while meeting 10% representation targets, without locking in MPAs, locking out oil rigs, and a boundary penalty of 0

ports_10 <- problem(cost_ports, features = features_stack) %>%
  add_min_set_objective() %>%
  add_relative_targets(0.1) %>% 
  add_locked_in_constraints(mpa_raster) %>% 
  add_locked_out_constraints(oil_raster) %>%
  add_gurobi_solver(gap = 0.1, time_limit = 1200)
  
# solve problem
sprob_ports_10 <- solve(ports_10)

# plot resutls
plot(sprob_ports_10,  main = c("Ports - 10% Targets"))
```

# SCENARIO 5: 50% Targets
```{r}
## SENSITIVTY ANALSYSIS TEST: Now lets run a sensitivity analysis with 50% targets

### OBJECTIVE: Minimize area while meeting 50% representation targets, without locking in MPAs, locking out oil rigs, and a boundary penatly of 0

ports_50 <- problem(cost_ports, features = features_stack) %>%
  add_min_set_objective() %>%
  add_relative_targets(0.5) %>% 
  add_locked_in_constraints(mpa_raster) %>% 
  add_locked_out_constraints(oil_raster) %>%
  add_gurobi_solver(gap = 0.1, time_limit = 1200)
  
# solve problem
sprob_ports_50 <- solve(ports_50)

# print results
plot(sprob_ports_50,  main = c("Ports - 50% Targets"))

```


## Now lets plot results next to each other to compare
```{r}
plotstack <- stack(sprob_ports_10, sprob_ports, sprob_ports_50)

tm_shape(plotstack)+
tm_raster(palette = c("#c6c5c5", "#409a00"), n=2, legend.show = FALSE) +
  tm_layout(title = c("(a)", "(b)", "(c)"))

tmap_save(filename = "outputs/ports_varying_targets.png")

```

## Now lets plot baseline restuls from all three scenarios to compare
```{r}
plotstack <- stack(sprob_area, sprob, sprob_ports)

tm_shape(plotstack)+
tm_raster(palette = c("#c6c5c5", "#409a00"), n=2, legend.show = FALSE) +
  tm_layout(title = c("(a)", "(b)", "(c)"))

tmap_save(filename = "outputs/comparison_20.png")
```


